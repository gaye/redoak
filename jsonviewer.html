<!doctype html>
<html lang='en'>
  <head>
    <meta charset='utf-8'>
    <style>
      div.branch {
        padding-left: 20px;
      }

      div.branch div.key {
        width: 60px;
      }

      div.branch div.key:after {
        content: ':';
        padding-right: 10px;
      }

      div.branch div.value.string:before {
        content: '"';
      }

      div.branch div.value.string:after {
        content: '"';
      }

      div.branch div.key, div.branch div.value {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <template name='json'>
      <link rel='js' href='widget.js'>
      <link rel='js' href='#json.js'>
      <div class='json'></div>
    </template>

    <use mx='json'>
      {
        "name": "root",
        "concat": [
          { "data": "&lt;html lang..." },
          { "name": "unbound", "var": "pagename" },
          { "data": "&lt;/title&gt;..." },
          {
            "name": "base",
            "concat": [
              { "data": "&lt;div class=\"title\"&gt;..." },
              { "name": "unbound", "var": "pagename" },
              { "data": "&lt;/div&gt;..." }
            ]
          },
          { "data": "&lt;/body&gt;&lt;/html&gt;" }
        ]
      }
    </use>

    <script id='json.js'>
      Widget.event('jsonchild').listen({
        html: function(obj) {
          var keyResult = '';
          var result = ' ';
          var value = obj.value;

          if (typeof obj.key == 'string') {
            keyResult = '<div class="key"> </div>';
          }

          if (typeof value == 'boolean' || typeof value == 'string' ||
              typeof value == 'number') {
            result = '<div class="value ' + typeof value + '"> </div>';
          } else if (Array.isArray(value)) {
            result = '[ <div class="children"></div> ]';
          } else if (typeof value == 'object') {
            result = '{ <div class="children"></div> }';
          }

          return '<div class="branch">' + keyResult + result + '</div>';
        },

        els: function() {
          return { children: this.el().querySelector('div.children') };
        },

        rendered: function(obj) {
          if (typeof obj.key == 'string') {
            this.el().firstChild.firstChild.nodeValue = obj.key;
          }

          var value = obj.value;
          if (typeof value == 'boolean' || typeof value == 'string' ||
              typeof value == 'number') {
            this.el().lastChild.firstChild.nodeValue = value;
          }

          var self = this;
          var makeWidget = function(key, value) {
            var widget = new Widget(['jsonchild']);
            var model = { key: i, value: obj.value[i] };
            widget.render(self.el('children'), null, model);
            self.addChild(widget);
          };

          if (Array.isArray(obj.value)) {
            for (var i = 0; i < obj.value.length; i++) {
              makeWidget(i, obj.value[i]);
            }
          } else if (typeof obj.value == 'object') {
            for (var i in obj.value) {
              makeWidget(i, obj.value[i]);
            }
          }
        }
      });

      Widget.event('json').listen({
        rendered: function(obj) {
          var widget = new Widget(['jsonchild']);
          widget.render(this.el(), null, { key: null, value: obj });
          this.addChild(widget);
        }
      });
    </script>
  </body>
</html>
